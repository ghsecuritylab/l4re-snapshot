<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>L4Re - L4 Runtime Environment: test.mk - Test Application Role</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="l4re.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">L4Re - L4 Runtime Environment
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('bid_role_test.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Modules</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">test.mk - Test Application Role </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The test role is very similar to the application role, it also builds an executable binary.</p>
<p>The difference is that is also builds for each target a test script that executes the test target either on the host (MODE=host) or a target platform (currently only qemu).</p>
<p>The role accepts all make variables that are accepted by the application role. The only difference is that the <code>TARGET</code> variable is not required. If it is missing, the source directory will be scanned for source files that fit the pattern <code>test_*.c[c]</code> and create one target for each of them.</p>
<dl class="section note"><dt>Note</dt><dd>It is possible to still use SRC_C[C] when targets are determined automatically. In that case the specified sources will be used in addition* to the main <code>test_*.c[c]</code> source.</dd></dl>
<p>In addition to the variables above, there are a number of variables that control how the test is executed. All these variables may be used as a global variable that applies to all test or, if the target name is added as a suffix, set for a specific target only.</p>
<dl class="section user"><dt>TEST_TARGET</dt><dd>Name of binary containing the test (default: same as <code>TARGET</code>).</dd></dl>
<dl class="section user"><dt>TEST_EXPECTED</dt><dd>File containing expected output. By default the variable is empty, which means the test binary is expected to produce TAP test output, that can be directly processed.</dd></dl>
<dl class="section user"><dt>TEST_EXPECTED_REPEAT</dt><dd>Number of times the expected output should be repeated, by default 1. When set to 0 then output is expected to repeat forever. This is particularly useful to make sure that stress tests that are meant to run in an endless loop are still alive. Note that such endless tests can only be run by directly executing the test script. They will be skipped when run in a test harness like <code>prove</code>.</dd></dl>
<dl class="section user"><dt>TEST_TIMEOUT</dt><dd>Non-standard timeout after which the test run is aborted (useful for tests involving sleep).</dd></dl>
<dl class="section user"><dt>MOE_CFG</dt><dd>LUA configuration file for startup to give to moe</dd></dl>
<dl class="section user"><dt>REQUIRED_MODS</dt><dd>Additional modules needed to run the test.</dd></dl>
<dl class="section user"><dt>QEMU_ARGS</dt><dd>Additional parameters to supply to QEMU.</dd></dl>
<dl class="section user"><dt>MOE_ARGS</dt><dd></dd></dl>
<p>Additional parameters to supply to moe.</p>
<dl class="section user"><dt>KERNEL_CONF</dt><dd>Features the Fiasco kernel must have been compiled with. A space-separated list of config options as used by Kconfig. <code>run_test</code> looks for a <code>globalconfig.out</code> file in the same directory as the kernel and checks that all options are enabled. If not, the test is skipped. Has only an effect if the <code>globalconfig.out</code> file is present.</dd></dl>
<dl class="section user"><dt>L4LINUX_CONF</dt><dd>Features the L4Linux kernel must have been compiled with. Similar to <code>KERNEL_CONF</code> but checks for a <code>.config</code> file in the directory of the L4Linux kernel.</dd></dl>
<dl class="section user"><dt>TEST_SETUP</dt><dd>Command to execute before the test is run. The test will only be executed if the command returns 0. If the exit code is 2, the test is marked as skipped with the reason provided in the final line of stdout.</dd></dl>
<p>In addition to compiled tests, it is also possible to create tests where the test binary or script comes from a different source. These tests must be listed in <code>EXTRA_TARGET</code> and for each target a custom <code>TEST_TARGET</code> must be provided.</p>
<h2>Running Tests </h2>
<p>The make role creates a test script which can be found in <code>&lt;builddir&gt;/test/t/&lt;arch&gt;/&lt;api&gt;</code>. It is possible to organise the tests further in subdirectories below by specifying a TEST_GROUP.</p>
<p>To be able to execute the test, a minimal test environment needs to be set up by exporting the following environment variables:</p>
<dl class="section user"><dt>KERNEL_&lt;arch&gt;_&lt;platform&gt;, KERNEL_&lt;arch&gt;, KERNEL</dt><dd>Fiasco kernel binary to use. The test runner is able to check if the kernel has all features necessary for the test and skip tests accordingly. In order for this to work, the <code>globalconfig.out</code> config file from the build directory needs to be available in the same directory as the kernel.</dd></dl>
<dl class="section user"><dt>L4LX_KERNEL_&lt;arch&gt;_&lt;platform&gt;, L4LX_KERNEL_&lt;arch&gt;, L4_LX_KERNEL</dt><dd>L4Linux binary to use. This is only required to run tests in <code>mode=l4linux</code>. If no L4Linux kernel is set then these tests will simply be skipped. The test runner is also able to check if the kernel has all features compiled in that are required to run the test successfully (see make variable <code>L4LINUX_CONF</code> above). For this to work, the <code>.config</code> configuration file from the build directory needs to be available in the same directory as the kernel.</dd></dl>
<dl class="section user"><dt>LINUX_RAMDISK_&lt;arch&gt;_&lt;platform&gt;, LINUX_RAMDISK_&lt;arch&gt;, LINUX_RAMDISK</dt><dd>Ramdisk to mount as root in L4Linux. This is only required to run tests in <code>mode=l4linux</code>. If not supplied, L4Linux tests will be skipped. The ramdisk must be set up to start the test directly after the initial startup is finished. The name of the test binary is supplied via the kernel command line option <code>l4re_testprog</code>. The <code>tool/test</code> directory contains an example script <code>launch-l4linux-test</code>. which can be copied onto the ramdisk and started by the init script.</dd></dl>
<p>In addition to these variables, the following BID variables can be overwritten at runtime: <code>PLATFORM_TYPE</code> and <code>TEST_TIMEOUT</code>. You may also supply <code>QEMU_ARGS</code> and <code>MOE_ARGS</code> which will be appended to the parameters specified in the BID test make file.</p>
<p>Once the environment is set up, the tests can be run either by simply executing all of them from the build directory with </p><pre class="fragment">make test
</pre><p>or executing them directly, like </p><pre class="fragment">test/t/amd64_amdfam10/l4f/l4re-core/moe/test_namespace.t
</pre><p>or running one or more tests through the test harness <a href="http://perldoc.perl.org/prove.html">prove</a>, like </p><pre class="fragment">prove test/t/amd64_amdfam10/l4f/l4re-core/moe/test_namespace.t
prove -r test/t/amd64_amdfam10/l4f/l4re-core/
prove -rv test/t/amd64_amdfam10/l4f/l4re-core/
</pre><h2>Debugging Tests </h2>
<p>The test script is only a thin wrapper that sets up the test environment as it was defined in the make file and then executes two scripts: <code>tapper-wrapper</code> and <code>run_test</code>.</p>
<p>The main work horse of the two is <code>tool/bin/run_test</code>. It collects the necessary files and starts qemu to execute the test. This script is always required.</p>
<p>There is then a second script wrapped around the test runner: <code>tool/bin/tapper-wrapper</code>. This tool inspects the output of the test runner and reformats it, so that it can be read by tools like <code>prove</code>. If the test produces tap output, then the script scans for this output and filters away all the debug output. If <code>TEST_EXPECTED</code> was defined, then the script scans the output for the expected lines and prints a suitable TAP message with success or failure. It also makes sure that qemu is killed as soon as the test is finished.</p>
<p>There are a number of command-line parameters that allow to quickly change test parameters for debugging purposes. Run the test with '&ndash;help' for more information about available parameters. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="l4re_concepts.html">Programming for L4Re</a></li><li class="navelem"><a class="el" href="l4re_build_system.html">L4Re Build System</a></li>
    <li class="footer">Generated on Wed Dec 30 2015 23:22:17 for L4Re - L4 Runtime Environment by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.8 </li>
  </ul>
</div>
</body>
</html>
